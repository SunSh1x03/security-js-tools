<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Security Dashboard + Web Attack Simulator</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a2f; --muted:#93a4c8; --text:#e7ecf7; --accent:#4cc9f0; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --card:#10182b; --border:#1f2a44;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0c1226 40%,#0b1020);color:var(--text);font:500 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:24px;font-weight:800;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 20px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer}
    .tab.active{outline:2px solid var(--accent);}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    @media(min-width:720px){.span-6{grid-column:span 6}.span-4{grid-column:span 4}.span-8{grid-column:span 8}}
    h2{margin:0 0 8px;font-size:18px}
    h3{margin:12px 0 6px;font-size:15px;color:var(--muted)}
    button, input, select, textarea{border-radius:10px;border:1px solid var(--border);background:#0d1528;color:var(--text);padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2152ff,#1a3bd6);border:0}
    button.ghost{background:transparent}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kpi{display:flex;flex-direction:column;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;min-width:120px}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .log{background:#0a0f1d;border:1px solid var(--border);border-radius:10px;padding:10px;min-height:120px;white-space:pre-wrap;overflow:auto}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1528;font-size:12px}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .divider{height:1px;background:var(--border);margin:10px 0}
    .code{background:#0a0f1d;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto}
    .hint{font-size:13px;color:var(--muted)}
    .footer{margin:22px 0 10px;color:var(--muted);font-size:13px}
    .pill{padding:3px 8px;border-radius:9999px;border:1px solid var(--border);background:#0d1528}
    .small{font-size:13px}
    .actions{display:flex;gap:8px;align-items:center}
    /* Mapa est√°tico */
    #mapWrap{display:block}
    #mapImg{width:100%;height:auto;border:1px solid var(--border);border-radius:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">Security Dashboard + Web Attack Simulator</div>
        <div class="subtitle">Single-file demo em JavaScript puro ‚Ä¢ pronto para subir no GitHub Pages</div>
      </div>
      <div class="row">
        <a class="badge" href="#" id="exportReadme">üìÑ Gerar README</a>
        <a class="badge" href="attackmap.html" target="_blank" id="openAttackmap">üó∫ Abrir Attack Map</a>
        <span class="pill">v1.2</span>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="dashboard">üìä Painel de Seguran√ßa (APIs)</button>
      <button class="tab" data-tab="simulator">üß™ Mini Simulador de Ataques Web</button>
      <button class="tab" data-tab="about">‚ÑπÔ∏è Sobre & Como publicar</button>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <div class="grid">
        <div class="card span-8">
          <h2>üîé IP & Geolocaliza√ß√£o (ipify + ipapi/ipinfo)</h2>
          <div class="row" style="margin:8px 0 12px">
            <button class="primary" id="btnIpInfo">Descobrir meu IP p√∫blico</button>
            <div class="actions">
              <button id="btnCopyGeo" class="ghost" title="Copiar JSON para clipboard">üìã Copiar JSON</button>
              <button id="btnDownloadGeo" class="ghost" title="Baixar JSON">‚¨áÔ∏è Baixar JSON</button>
            </div>
            <span class="hint">Sem chave. Use em HTTPS/GitHub Pages para evitar CORS. Fallback autom√°tico de provedor.</span>
          </div>

          <div class="row">
            <div class="kpi"><span class="muted">IP</span><strong id="ipValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Pa√≠s</span><strong id="countryValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Regi√£o</span><strong id="regionValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Cidade</span><strong id="cityValue">‚Äî</strong></div>
          </div>

          <div style="height:8px"></div>

          <div class="row">
            <div class="kpi"><span class="muted">ASN</span><strong id="asnValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Org / ISP</span><strong id="orgValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">CEP</span><strong id="postalValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Timezone</span><strong id="timezoneValue">‚Äî</strong></div>
          </div>

          <div style="height:8px"></div>

          <div class="row">
            <div class="kpi"><span class="muted">Lat</span><strong id="latValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Lon</span><strong id="lonValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Currency</span><strong id="currencyValue">‚Äî</strong></div>
            <div class="kpi"><span class="muted">Dial Code</span><strong id="callingCodeValue">‚Äî</strong></div>
          </div>

          <div class="divider"></div>
          <div id="mapWrap" hidden>
            <img id="mapImg" alt="Mapa est√°tico aproximado da localiza√ß√£o do IP">
          </div>
          <div class="divider"></div>
          <div class="row small">
            <span class="pill">Provedor: <span id="geoProvider">‚Äî</span></span>
          </div>
          <div class="divider"></div>
          <div class="log" id="ipLog">Nenhuma consulta ainda.</div>
        </div>

        <div class="card span-4">
          <h2>üß∞ Checagem de senha vazada (k-anon)</h2>
          <div class="row">
            <input id="pwdInput" type="password" placeholder="Digite uma senha de teste" style="flex:1" />
            <button id="btnPwdCheck">Verificar</button>
          </div>
          <div class="hint">Usa <span class="mono">api.pwnedpasswords.com</span> (k-anon) ‚Äî nada da sua senha √© enviada em texto claro.</div>
          <div class="divider"></div>
          <div class="log" id="pwdLog">Nenhuma verifica√ß√£o ainda.</div>
        </div>

        <div class="card span-12">
          <h2>üß© Integra√ß√µes opcionais (VirusTotal, Shodan, HIBP)</h2>
          <div class="row" style="gap:16px">
            <div>
              <label class="muted">VirusTotal API Key</label><br/>
              <input id="vtKey" type="password" placeholder="Use proxy seguro" autocomplete="off" style="min-width:280px" />
            </div>
            <div>
              <label class="muted">Shodan API Key</label><br/>
              <input id="shodanKey" type="password" placeholder="Use proxy seguro" autocomplete="off" style="min-width:280px" />
            </div>
            <div>
              <label class="muted">HIBP API Key</label><br/>
              <input id="hibpKey" type="password" placeholder="Use proxy seguro" autocomplete="off" style="min-width:280px" />
            </div>
          </div>
          <div class="hint">As entradas est√£o desativadas: configure um backend/serverless para armazenar chaves em vari√°veis de ambiente e expor endpoints p√∫blicos.</div>
          <h3>Consulta de URL no VirusTotal</h3>
          <div class="row">
            <input id="vtUrl" placeholder="https://exemplo.com" style="flex:1" />
            <button id="btnVtCheck">Checar</button>
            <button class="ghost" id="btnVtMock">Mockar resposta</button>
          </div>
          <div class="divider"></div>
          <div class="log" id="vtLog">Configure <span class="mono">window.VIRUSTOTAL_PROXY_URL</span> apontando para um proxy seguro ou use "Mockar resposta".</div>
        </div>
      </div>
    </section>

    <!-- SIMULATOR -->
    <section id="simulator" class="tabpanel" hidden>
      <div class="grid">
        <div class="card span-6">
          <h2>üß™ XSS Sandbox (did√°tico)</h2>
          <div class="hint">Demonstra a diferen√ßa entre renderiza√ß√£o insegura (<span class="mono">innerHTML</span>) e segura (<span class="mono">textContent</span>).</div>
          <div class="row" style="margin:10px 0">
            <input id="xssInput" placeholder='Ex.: <img src=x onerror=alert(1)>' style="flex:1" />
            <select id="xssMode">
              <option value="safe">Seguro (escapar)</option>
              <option value="unsafe">Inseguro (executa)</option>
              <option value="sandbox">Iframe sandbox</option>
            </select>
            <button id="btnXssRender">Renderizar</button>
          </div>
          <div class="row" style="gap:16px">
            <div class="kpi"><span class="muted">Modo</span><strong id="xssModeLabel">Seguro</strong></div>
            <div class="kpi"><span class="muted">Execu√ß√£o</span><strong id="xssExec">Bloqueada</strong></div>
          </div>
          <div class="divider"></div>
          <div id="xssOutput" class="code">Sa√≠da aparecer√° aqui‚Ä¶</div>
          <iframe id="xssFrame" style="width:100%;height:130px;border:1px solid var(--border);border-radius:10px;margin-top:10px" hidden sandbox></iframe>
        </div>

        <div class="card span-6">
          <h2>üóÑÔ∏è SQL Injection (simula√ß√£o)</h2>
          <div class="hint">Banco fict√≠cio em mem√≥ria. Demonstra <em>OR '1'='1'</em> e preven√ß√£o por par√¢metros.</div>
          <div class="row" style="margin:10px 0">
            <input id="sqlUser" placeholder="Usu√°rio"/>
            <input id="sqlPass" placeholder="Senha"/>
            <select id="sqlMode">
              <option value="vulnerable">Vulner√°vel (string concat)</option>
              <option value="safe">Seguro (parametrizado)</option>
            </select>
            <button id="btnSqlLogin">Login</button>
          </div>
          <div class="divider"></div>
          <div class="log" id="sqlLog">Tente: usu√°rio <span class="mono">admin</span> e senha <span class="mono">' OR '1'='1</span> no modo Vulner√°vel.</div>
        </div>

        <div class="card span-12">
          <h2>üìö Conceitos & Mitiga√ß√µes</h2>
          <ul>
            <li><strong>XSS:</strong> Nunca renderize entrada do usu√°rio com <span class="mono">innerHTML</span> sem sanitiza√ß√£o. Prefira <span class="mono">textContent</span> ou bibliotecas de sanitiza√ß√£o (DOMPurify).</li>
            <li><strong>SQLi:</strong> Use <em>prepared statements</em>/queries parametrizadas, valida√ß√£o de entrada e <em>least privilege</em> no DB.</li>
            <li><strong>APIs:</strong> Nunca exponha chaves de API no frontend; use proxies/serverless (Netlify/Vercel) para chamadas que exigem segredo.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="tabpanel" hidden>
      <div class="card">
        <h2>Como usar & publicar</h2>
        <ol>
          <li>Crie um reposit√≥rio no GitHub, por exemplo <span class="mono">security-js-lab</span>.</li>
          <li>Adicione este arquivo <span class="mono">index.html</span> na raiz.</li>
          <li>Ative o GitHub Pages: <em>Settings ‚Üí Pages ‚Üí Deploy from a branch ‚Üí main /root</em>.</li>
          <li>Para usar APIs com chave (VirusTotal/Shodan/HIBP), configure um proxy:
            <ul>
              <li><strong>Vercel/Netlify:</strong> crie uma fun√ß√£o serverless que l√™ a chave de vari√°veis de ambiente e chama a API.</li>
              <li>Atualize os endpoints neste arquivo para apontar para seu proxy.</li>
            </ul>
          </li>
        </ol>
        <div class="divider"></div>
        <h3>Estrutura do projeto sugerida</h3>
        <pre class="code">security-js-lab/
‚îú‚îÄ index.html  ‚Üê (este arquivo √∫nico)
‚îî‚îÄ (opcional) functions/   ‚Üê proxy serverless para APIs com segredo
</pre>
        <div class="divider"></div>
        <p class="hint">Autor: Filipe Penido ‚Ä¢ Licen√ßa sugerida: MIT (para projetos de portfolio/estudo).</p>
      </div>
    </section>

    <div class="footer">Este projeto √© did√°tico. N√£o √© um scanner real de rede e n√£o deve ser usado para atividade ofensiva sem autoriza√ß√£o.</div>
  </div>

  <script>
    // =======================
    // Utils
    // =======================
    const $ = sel => document.querySelector(sel);

    function log(el, msg){
      const now = new Date().toLocaleString()
      const prev = el.textContent || ''
      el.textContent = prev ? prev + '\\n' + `[${now}] ${msg}` : `[${now}] ${msg}`
      el.scrollTop = el.scrollHeight
    }

    const json = obj => JSON.stringify(obj, null, 2);

    async function fetchWithTimeout(url, opts = {}, timeout = 8000){
      const controller = new AbortController()
      const id = setTimeout(()=>controller.abort(), timeout)
      try{
        const resp = await fetch(url, {...opts, signal: controller.signal})
        clearTimeout(id)
        return resp
      }catch(e){
        clearTimeout(id)
        throw e
      }
    }

    // Normaliza√ß√£o para provedores diferentes
    function normalizeGeo(provider, raw){
      if(provider === 'ipapi'){
        return {
          provider,
          ip: raw?.ip ?? null,
          country_name: raw?.country_name ?? null,
          region: raw?.region ?? raw?.region_code ?? null,
          city: raw?.city ?? null,
          postal: raw?.postal ?? raw?.postal_code ?? null,
          latitude: raw?.latitude ?? raw?.lat ?? null,
          longitude: raw?.longitude ?? raw?.lon ?? null,
          timezone: raw?.timezone ?? null,
          asn: raw?.asn ?? raw?.org ?? null,
          org: raw?.org ?? raw?.isp ?? raw?.organization ?? null,
          currency: raw?.currency ?? raw?.currency_code ?? null,
          calling_code: raw?.country_calling_code ?? raw?.country_phone ?? null,
          raw
        }
      }
      if(provider === 'ipinfo'){
        return {
          provider,
          ip: raw?.ip ?? null,
          country_name: raw?.country ?? null, // c√≥digo do pa√≠s (ex.: BR)
          region: raw?.region ?? null,
          city: raw?.city ?? null,
          postal: raw?.postal ?? null,
          latitude: raw?.loc ? Number(raw.loc.split(',')[0]) : null,
          longitude: raw?.loc ? Number(raw.loc.split(',')[1]) : null,
          timezone: raw?.timezone ?? null,
          asn: raw?.org ?? null, // "ASxxxx ISP"
          org: raw?.hostname || raw?.org || null,
          currency: null,
          calling_code: null,
          raw
        }
      }
      return { provider, raw }
    }

    // =======================
    // Backends opcionais (exemplo)
    // =======================
    const vtProxy = typeof window !== 'undefined' && window.VIRUSTOTAL_PROXY_URL
      ? String(window.VIRUSTOTAL_PROXY_URL).trim()
      : '';

    const API_BASE = "https://php-sectools.onrender.com"; // opcional

    async function loadGraph(id){
      const resp = await fetch(`${API_BASE}/api/graph?id=${encodeURIComponent(id)}`);
      if(!resp.ok) throw new Error('Falha ao buscar graph: ' + resp.status);
      return resp.json();
    }

    // =======================
    // Tabs
    // =======================
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'))
        btn.classList.add('active')
        const target = btn.dataset.tab
        document.querySelectorAll('.tabpanel').forEach(p=>p.hidden = p.id!==target)
      })
    })

    // =======================
    // Mapa est√°tico (OpenStreetMap Static)
    // =======================
    function updateStaticMap(lat, lon, zoom = 10){
      const wrap = $('#mapWrap')
      const img = $('#mapImg')
      if(typeof lat !== 'number' || typeof lon !== 'number'){ wrap.hidden = true; return }
      // Par√¢metros da imagem: tamanho em px (se ajusta via CSS), zoom e marcador
      const width = 1024; // geramos maior para ficar n√≠tido em telas retina (escala pelo CSS)
      const height = 340;
      const marker = `${lat},${lon},red-pushpin`
      const url = `https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lon}&zoom=${zoom}&size=${width}x${height}&maptype=mapnik&markers=${marker}`
      img.src = url
      wrap.hidden = false
    }

    // =======================
    // IP & GEO
    // =======================
    let lastGeoJson = null;

    async function getPublicIp(){
      const r = await fetchWithTimeout('https://api.ipify.org?format=json', {}, 7000)
      if(!r.ok) throw new Error('api.ipify.org retornou ' + r.status)
      return r.json()
    }

    async function getGeoIpapi(ip){
      const r = await fetchWithTimeout(`https://ipapi.co/${encodeURIComponent(ip)}/json/`, {}, 9000)
      if(!r.ok) throw new Error('ipapi.co retornou ' + r.status)
      const raw = await r.json()
      return normalizeGeo('ipapi', raw)
    }

    async function getGeoIpinfo(ip){
      const r = await fetchWithTimeout(`https://ipinfo.io/${encodeURIComponent(ip)}/json`, {}, 9000)
      if(!r.ok) throw new Error('ipinfo.io retornou ' + r.status)
      const raw = await r.json()
      return normalizeGeo('ipinfo', raw)
    }

    async function resolveGeo(ipLog){
      try{
        log(ipLog, 'Consultando geo (ipapi.co)‚Ä¶')
        return await getGeoIpapi($('#ipValue').textContent)
      }catch(e1){
        log(ipLog, `Falha ipapi: ${(e1?.message||e1)}. Tentando ipinfo.io‚Ä¶`)
        try{
          return await getGeoIpinfo($('#ipValue').textContent)
        }catch(e2){
          throw new Error(`Falha no fallback ipinfo: ${(e2?.message||e2)}`)
        }
      }
    }

    function renderGeoToUI(geo){
      $('#countryValue').textContent = geo.country_name || '‚Äî'
      $('#regionValue').textContent = geo.region || '‚Äî'
      $('#cityValue').textContent = geo.city || '‚Äî'
      $('#asnValue').textContent = geo.asn || '‚Äî'
      $('#orgValue').textContent = geo.org || '‚Äî'
      $('#postalValue').textContent = geo.postal || '‚Äî'
      $('#timezoneValue').textContent = geo.timezone || '‚Äî'
      $('#latValue').textContent = (geo.latitude ?? '‚Äî')
      $('#lonValue').textContent = (geo.longitude ?? '‚Äî')
      $('#currencyValue').textContent = geo.currency || '‚Äî'
      $('#callingCodeValue').textContent = geo.calling_code || '‚Äî'
      $('#geoProvider').textContent = geo.provider || '‚Äî'
      if(typeof geo.latitude === 'number' && typeof geo.longitude === 'number'){
        updateStaticMap(geo.latitude, geo.longitude, 10)
      }else{
        $('#mapWrap').hidden = true
      }
    }

    $('#btnIpInfo').addEventListener('click', async ()=>{
      const ipLog = $('#ipLog');
      ipLog.textContent = '';
      $('#mapWrap').hidden = true
      log(ipLog, 'Buscando IP p√∫blico‚Ä¶')
      try{
        const ipObj = await getPublicIp()
        const ip = ipObj?.ip
        if(!ip) throw new Error('Resposta de IP vazia.')
        $('#ipValue').textContent = ip
        log(ipLog, `IP p√∫blico: ${ip}`)

        const geo = await resolveGeo(ipLog)
        lastGeoJson = { ip: ipObj, geo }
        renderGeoToUI(geo)
        log(ipLog, 'Geo normalizado:')
        log(ipLog, json(geo))
      }catch(e){
        const msg = e?.name === 'AbortError' ? 'Tempo esgotado (timeout).' : (e?.message || e)
        log(ipLog, `Erro ao consultar: ${msg} Poss√≠vel CORS/rate-limit. Rode via HTTPS/GitHub Pages ou utilize um proxy server-side.`)
      }
    })

    // Copiar / baixar JSON
    $('#btnCopyGeo').addEventListener('click', async ()=>{
      const out = $('#ipLog')
      if(!lastGeoJson){ log(out, 'Nenhum JSON dispon√≠vel. Clique em "Descobrir meu IP p√∫blico" primeiro.'); return }
      try{
        await navigator.clipboard.writeText(json(lastGeoJson))
        log(out, 'JSON copiado para clipboard.')
      }catch(e){
        log(out, 'Falha ao copiar para clipboard: ' + (e?.message || e))
      }
    })

    $('#btnDownloadGeo').addEventListener('click', ()=>{
      const out = $('#ipLog')
      if(!lastGeoJson){ log(out, 'Nenhum JSON dispon√≠vel. Clique em "Descobrir meu IP p√∫blico" primeiro.'); return }
      const blob = new Blob([json(lastGeoJson)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = `geo-${(new Date()).toISOString().replace(/[:.]/g,'-')}.json`; a.click()
      URL.revokeObjectURL(url)
      log(out, 'JSON baixado.')
    })

    // =======================
    // Pwned Passwords (k-anon)
    // =======================
    async function sha1(str){
      const buf = new TextEncoder().encode(str)
      const hash = await crypto.subtle.digest('SHA-1', buf)
      return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase()
    }

    $('#btnPwdCheck').addEventListener('click', async ()=>{
      const pwd = $('#pwdInput').value
      const out = $('#pwdLog')
      if(!pwd){ log(out,'Digite uma senha para verificar.'); return }
      out.textContent = ''
      log(out,'Calculando SHA1 (k-anon)‚Ä¶')
      try{
        const h = await sha1(pwd)
        const prefix = h.slice(0,5)
        const suffix = h.slice(5)
        const resp = await fetchWithTimeout(`https://api.pwnedpasswords.com/range/${prefix}`, {}, 9000)
        if(!resp.ok) throw new Error('api.pwnedpasswords retornou ' + resp.status)
        const text = await resp.text()
        const lines = text.split('\\n')
        const hit = lines.find(l=>l.toUpperCase().startsWith(suffix.toUpperCase()))
        if(hit){
          const count = hit.split(':')[1]?.trim() || '?'
          out.innerHTML = `‚ö†Ô∏è <strong class="bad">Senha j√° vazou</strong> (${count} ocorr√™ncia(s)). Troque imediatamente.`
        }else{
          out.innerHTML = `‚úÖ <strong class="ok">N√£o encontrada</strong> nesta base. Ainda assim use senhas √∫nicas + 2FA.`
        }
      }catch(e){
        log(out,'Erro na consulta. Poss√≠vel CORS/timeout. Abra via GitHub Pages/HTTPS.')
      }
    })

    // =======================
    // VirusTotal (via proxy)
    // =======================
    const vtKeyInput = $('#vtKey')
    const shodanKeyInput = $('#shodanKey')
    const hibpKeyInput = $('#hibpKey')
    ;[vtKeyInput, shodanKeyInput, hibpKeyInput].forEach(input => {
      if(!input) return
      input.value = ''
      input.disabled = true
      input.title = 'Chaves devem permanecer em um backend ou proxy seguro.'
    })

    const vtCheckButton = $('#btnVtCheck')
    const vtLog = $('#vtLog')
    if(!vtProxy){
      vtCheckButton.disabled = true
      vtCheckButton.title = 'Defina window.VIRUSTOTAL_PROXY_URL antes de habilitar esta fun√ß√£o.'
      log(vtLog, 'Defina window.VIRUSTOTAL_PROXY_URL com a URL do seu proxy seguro (serverless/backend) para habilitar a consulta real.')
    }else{
      vtCheckButton.disabled = false
      vtCheckButton.title = 'Consulta via proxy seguro configurado.'
    }

    $('#btnVtMock').addEventListener('click', ()=>{
      const sample = { data: { attributes: { last_analysis_stats: { harmless: 67, malicious: 2, suspicious: 1, undetected: 15 }}} };
      vtLog.textContent = json(sample)
    })

    $('#btnVtCheck').addEventListener('click', async ()=>{
      const url = $('#vtUrl').value.trim()
      const out = vtLog
      if(!vtProxy){ log(out,'Defina window.VIRUSTOTAL_PROXY_URL apontando para um proxy que proteja sua chave antes de usar.'); return }
      if(!url){ log(out,'Informe uma URL para checar.'); return }
      log(out,'Consultando VirusTotal via proxy seguro‚Ä¶')
      try{
        const resp = await fetch(vtProxy,{
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body: JSON.stringify({ url })
        })
        if(!resp.ok){
          const body = await resp.text()
          throw new Error(`Proxy retornou ${resp.status}. ${body || ''}`.trim())
        }
        const data = await resp.json()
        log(out, 'Resposta do proxy:')
        log(out, json(data))
      }catch(e){ log(out, `Falha ao consultar via proxy: ${e?.message || e}`) }
    })

    // =======================
    // XSS
    // =======================
    $('#btnXssRender').addEventListener('click', ()=>{
      const mode = $('#xssMode').value
      const input = $('#xssInput').value
      $('#xssModeLabel').textContent = mode === 'safe' ? 'Seguro' : (mode==='sandbox'?'Sandbox':'Inseguro')
      const exec = $('#xssExec')
      const out = $('#xssOutput')
      const frame = $('#xssFrame')
      out.textContent = ''
      frame.hidden = true
      if(mode==='safe'){
        exec.textContent = 'Bloqueada'
        out.textContent = input
      }else if(mode==='unsafe'){
        exec.textContent = 'Permitida ‚ö†Ô∏è'
        out.innerHTML = input // N√ÉO FA√áA ISSO EM PRODU√á√ÉO
      }else{
        exec.textContent = 'Isolada (iframe)'
        frame.hidden = false
        const doc = frame.contentDocument
        doc.open();
        doc.write(`<!doctype html><html><body style="background:#0a0f1d;color:#e7ecf7;font-family:system-ui">
          <div>Sandbox iframe (scripts s√≥ aqui):</div>
          <div>${input}</div>
        </body></html>`)
        doc.close();
      }
    })

    // =======================
    // SQLi
    // =======================
    const USERS = [
      {id:1, user:'admin', pass:'secret', role:'admin'},
      {id:2, user:'maria', pass:'123456', role:'user'},
      {id:3, user:'joao', pass:'hunter2', role:'user'},
    ]

    function vulnerableLogin(u, p){
      const query = `SELECT * FROM users WHERE user='${u}' AND pass='${p}'`;
      let result
      if(/'\s*OR\s*'1'='1/i.test(p)){
        result = USERS
      }else{
        result = USERS.filter(r=>r.user===u && r.pass===p)
      }
      return {query, result}
    }

    function safeLogin(u, p){
      const query = 'SELECT * FROM users WHERE user = ? AND pass = ?'
      const params = [u, p]
      const result = USERS.filter(r=>r.user===u && r.pass===p)
      return {query, params, result}
    }

    $('#btnSqlLogin').addEventListener('click', ()=>{
      const u = $('#sqlUser').value
      const p = $('#sqlPass').value
      const mode = $('#sqlMode').value
      const out = $('#sqlLog')
      if(mode==='vulnerable'){
        const {query, result} = vulnerableLogin(u,p)
        out.textContent = `${query}\\n\\nResultado: ${json(result)}`
      }else{
        const {query, params, result} = safeLogin(u,p)
        out.textContent = `${query}\\nParams: ${json(params)}\\n\\nResultado: ${json(result)}`
      }
    })

    // =======================
    // README export
    // =======================
    $('#exportReadme').addEventListener('click', ()=>{
      const md = `# Security Dashboard + Web Attack Simulator (JS)

Projeto did√°tico em **HTML/CSS/JS puro** (single-file) para portf√≥lio:

- **Painel de Seguran√ßa (APIs)**: IP p√∫blico, geolocaliza√ß√£o (com fallback), **mapa est√°tico** OpenStreetMap (sem depend√™ncias externas JS), checagem de senha vazada (k-anon) e integra√ß√µes opcionais (VirusTotal/Shodan/HIBP) com *mock*.
- **Mini Simulador de Ataques**: XSS (seguro/inseguro/sandbox) e SQL Injection (vulner√°vel vs. seguro com par√¢metros).

## Como rodar
1. Fa√ßa upload de \`index.html\` no seu reposit√≥rio (ex.: \`security-js-lab\`).
2. Ative o **GitHub Pages** em *Settings ‚Üí Pages*.
3. Abra a URL do Pages em **HTTPS** (evita CORS). Se der *rate-limit*, tente novamente ap√≥s alguns minutos.

## APIs
- **IP**: \`https://api.ipify.org?format=json\`
- **Geo** (fallback): \`https://ipapi.co/<IP>/json/\` ‚Üí \`https://ipinfo.io/<IP>/json\`
- **Mapa est√°tico**: \`https://staticmap.openstreetmap.de/staticmap.php?center=<lat>,<lon>&zoom=10&size=1024x340&markers=<lat>,<lon>,red-pushpin\`
- **Pwned Passwords (k-anon)**: \`https://api.pwnedpasswords.com/range/<prefixoSHA1>\`

## Seguran√ßa
- Evite \`innerHTML\` para entrada do usu√°rio.
- Use *prepared statements* no backend.
- N√£o exponha chaves de API no frontend; use proxy com vari√°veis de ambiente.

## Licen√ßa
MIT

## üë§ Autor & Cr√©ditos
Projeto por **Filipe Penido**. Partes do c√≥digo foram prototipadas com IA; todo o conte√∫do final foi revisado pelo autor.
`
      const blob = new Blob([md], {type:'text/markdown'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = 'README.md'; a.click()
      URL.revokeObjectURL(url)
    })
  </script>
</body>
</html>
